<ion-header>
  <ion-toolbar class="page-toolbar">
    <ion-buttons slot="start" *ngIf="view !== 'list'">
      <ion-button fill="clear" (click)="goBack()">
        <ion-icon name="arrow-back"></ion-icon>
      </ion-button>
    </ion-buttons>

    <ion-title>RSearch</ion-title>

    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="openCognitiveSearch()" *ngIf="view === 'list'">
        <ion-icon name="search-outline"></ion-icon>
      </ion-button>

      <ion-button fill="clear">
        <ion-icon name="notifications-outline"></ion-icon>
      </ion-button>

      <ion-button fill="clear">
        <ion-icon name="shield-checkmark-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="page">
  <ng-container [ngSwitch]="view">

    <!-- ========== LIST VIEW (Insights History) ========== -->
    <section *ngSwitchCase="'list'" class="list-view">
      <div class="bg-spacer"></div>

      <!-- AI Question Bar -->
      <div class="ask-bar">
        <ion-item lines="none" class="ask-card">
          <ion-input placeholder="Ask AI anything about your friends" [(ngModel)]="keyword"
            (keyup.enter)="openSearch()"></ion-input>
          <ion-icon name="sparkles-outline" slot="end" (click)="openSearch()"
            style="cursor: pointer; color: var(--ion-color-primary);"></ion-icon>
        </ion-item>
      </div>

      <!-- Insights History List -->
      <ion-list lines="none" class="history-list" *ngIf="insights().length; else emptyHistory">
        <ion-item button detail="false" class="history-card" *ngFor="let ins of insights(); trackBy: trackByInsight"
          (click)="openFromHistory(ins)">
          <ion-icon name="sparkles-outline" slot="start"></ion-icon>
          <ion-label>
            <h2>{{ ins.content }}</h2>
            <p>
              {{ ins.insight_type | titlecase }}
              â€¢
              {{ ins.generated_at | date:'short' }}
            </p>
            <p *ngIf="ins.contact_name" class="contact-pill">
              For: {{ ins.contact_name }}
            </p>
          </ion-label>
        </ion-item>
      </ion-list>

      <ng-template #emptyHistory>
        <div class="empty-history">
          <ion-icon name="sparkles-outline" style="font-size: 48px; opacity: 0.3;"></ion-icon>
          <p>No AI insights yet.</p>
          <p>Ask a question about your friends to get started!</p>
        </div>
      </ng-template>
    </section>

    <!-- ========== COGNITIVE SEARCH VIEW ========== -->
    <section *ngSwitchCase="'search'" class="search-view">
      <div class="search-header">
        <h2>Search by Patterns</h2>
        <p>Find contacts by traits, interests, or behaviors</p>
      </div>

      <!-- Search Bar -->
      <ion-searchbar [(ngModel)]="searchTerm" (ionChange)="onSearch()" (ionClear)="clearSearch()"
        placeholder="e.g., 'likes hiking', 'extroverted', 'tech interested'" [debounce]="500"></ion-searchbar>

      <!-- Search Examples -->
      <div class="search-examples" *ngIf="!hasSearched()">
        <p>Try searching for:</p>
        <ion-chip (click)="searchTerm='extroverted'; onSearch()">
          <ion-label>extroverted</ion-label>
        </ion-chip>
        <ion-chip (click)="searchTerm='likes technology'; onSearch()">
          <ion-label>likes technology</ion-label>
        </ion-chip>
        <ion-chip (click)="searchTerm='direct communication'; onSearch()">
          <ion-label>direct communication</ion-label>
        </ion-chip>
        <ion-chip (click)="searchTerm='creative'; onSearch()">
          <ion-label>creative</ion-label>
        </ion-chip>
      </div>

      <!-- Loading -->
      <div class="search-loading" *ngIf="isSearching()">
        <ion-spinner></ion-spinner>
        <p>Searching cognitive patterns...</p>
      </div>

      <!-- No Results -->
      <div class="no-results" *ngIf="hasSearched() && searchResults().length === 0 && !isSearching()">
        <ion-icon name="search-outline" style="font-size: 48px; opacity: 0.3;"></ion-icon>
        <p>No contacts found matching "{{ searchTerm }}"</p>
        <p>Try different keywords or traits</p>
      </div>
    </section>

    <!-- ========== SEARCH RESULTS VIEW ========== -->
    <section *ngSwitchCase="'results'" class="results-view">
      <div class="results-header">
        <h2>Search Results</h2>
        <p>{{ searchResults().length }} contact(s) found for "{{ searchTerm }}"</p>
      </div>

      <ion-list lines="none">
        <ion-card *ngFor="let result of searchResults(); trackBy: trackBySearchResult" class="result-card"
          (click)="viewContactDetails(result)">
          <ion-card-header>
            <div class="result-header">
              <ion-card-title>{{ result.contact_name }}</ion-card-title>
              <ion-badge [color]="getScoreColor(result.score)">
                {{ result.score }}
              </ion-badge>
            </div>
            <p class="relationship" *ngIf="result.relationship">
              {{ result.relationship }}
            </p>
          </ion-card-header>

          <ion-card-content>
            <!-- Matched Patterns -->
            <div class="matched-patterns" *ngIf="result.matched_patterns.length > 0">
              <strong>Matched Patterns:</strong>
              <p>{{ formatMatchedPatterns(result.matched_patterns) }}</p>
            </div>

            <!-- Recent Interaction -->
            <div class="recent-interaction" *ngIf="result.recent_interaction">
              <strong>Recent:</strong>
              <p>{{ result.recent_interaction }}</p>
            </div>

            <!-- Stats -->
            <div class="result-stats">
              <ion-chip>
                <ion-label>{{ result.total_interactions }} interactions</ion-label>
              </ion-chip>
              <ion-chip>
                <ion-label>Confidence: {{ result.confidence_avg.toFixed(1) }}/5</ion-label>
              </ion-chip>
            </div>
          </ion-card-content>
        </ion-card>
      </ion-list>

      <!-- Back to Search -->
      <div class="back-to-search">
        <ion-button expand="block" fill="outline" (click)="view = 'search'">
          <ion-icon name="search-outline" slot="start"></ion-icon>
          New Search
        </ion-button>
      </div>
    </section>

    <!-- ========== AI QUESTION VIEW ========== -->
    <section *ngSwitchCase="'ai-question'" class="ai-question-view">
      <ion-list lines="none" class="form-list">
        <!-- Contact Selector -->
        <ion-item class="pill-card">
          <ion-icon name="person-outline" slot="start"></ion-icon>
          <ion-select interface="action-sheet" placeholder="Select Contact" [(ngModel)]="selectedContact">
            <ion-select-option *ngFor="let c of contacts()" [value]="c">
              {{ contactLabel(c) }}
            </ion-select-option>
          </ion-select>
          <ion-icon name="chevron-down-outline" slot="end"></ion-icon>
        </ion-item>

        <!-- Question Input -->
        <ion-item class="question-card" lines="none">
          <ion-icon name="reorder-three-outline" slot="start"></ion-icon>
          <ion-textarea auto-grow="true" placeholder="Ask anything about this contact..." [(ngModel)]="question"
            rows="3"></ion-textarea>
        </ion-item>

        <!-- Send Button -->
        <div class="send-wrap">
          <ion-button class="send-btn" expand="block" (click)="send()" [disabled]="loading()">
            <ion-icon slot="start" name="paper-plane-outline"></ion-icon>
            {{ loading() ? 'Generating...' : 'Send' }}
          </ion-button>
        </div>

        <!-- AI Answer Display -->
        <ion-card class="ai-answer-card" *ngIf="aiAnswer()">
          <ion-card-header>
            <ion-icon name="sparkles-outline" color="primary"></ion-icon>
            <ion-card-title>AI Insight</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            {{ aiAnswer() }}
          </ion-card-content>
        </ion-card>
      </ion-list>
    </section>

  </ng-container>
</ion-content>