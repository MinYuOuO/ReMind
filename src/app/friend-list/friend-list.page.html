<ion-header>
  <ion-toolbar class="page-toolbar">
    <ion-title>Home</ion-title>

    <ion-buttons slot="end">
      <ion-button fill="clear">
        <ion-icon name="notifications-outline"></ion-icon>
      </ion-button>
      <ion-button fill="clear">
        <ion-icon name="shield-checkmark-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="page">
  <!-- Search -->
  <div class="search-container">
    <ion-searchbar
      placeholder="Search"
      class="search"
      [value]="query()"
      (ionInput)="onSearch($event)"
      debounce="300"
    ></ion-searchbar>
  </div>

  <!-- Empty state -->
  <div *ngIf="!loading() && contacts().length === 0" class="empty">
    <img src="assets/add-friend.svg" alt="No friends" />
    <h2>No friends yet</h2>
    <p>Start by adding someone you care about.</p>
  </div>

  <!-- Friend list -->
  <ion-list *ngIf="filteredContacts().length > 0" class="contacts-list">
    <ion-item
      *ngFor="let c of filteredContacts(); trackBy: trackById"
      class="contact-card"
      lines="none"
      button
      (click)="openEdit(c)"
    >
      <div slot="start" class="avatar">
        <ion-icon name="person-outline"></ion-icon>
      </div>
      <ion-label class="main-label">
        <h2 class="name">{{ c.name }}</h2>
        <p class="meta">{{ c.relationship || 'Friend' }}</p>
      </ion-label>
    </ion-item>
  </ion-list>

  <!-- Add button -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button class="fab-add" (click)="onAdd()">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>

  <!-- Add/Edit Modal -->
  <ion-modal [isOpen]="showModal()" cssClass="friend-modal">
    <ng-template>
      <div class="edit-screen">
        <ion-header>
          <ion-toolbar class="edit-toolbar">
            <ion-buttons slot="start">
              <ion-button (click)="onCancel()">
                <ion-icon name="arrow-back"></ion-icon>
              </ion-button>
            </ion-buttons>

            <ion-title class="edit-title">
              {{ editingContactId ? 'Edit Friend' : 'New Friend' }}
            </ion-title>

            <ion-buttons slot="end" *ngIf="editingContactId">
              <ion-button color="danger" (click)="confirmDelete($event)">
                <ion-icon name="trash"></ion-icon>
              </ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>

        <ion-content class="edit-content">
          <div class="profile-area">
            <div class="profile-camera">
              <ion-icon name="camera"></ion-icon>
            </div>
            <div class="offline-label">Person</div>
          </div>

          <ion-list class="fields-list">
            <ion-item class="field-card" lines="none">
              <ion-icon
                slot="start"
                name="person-outline"
                class="field-icon"
              ></ion-icon>
              <ion-input
                placeholder="Name"
                [(ngModel)]="newContact.name"
              ></ion-input>
            </ion-item>

            <ion-item class="field-card" lines="none">
              <ion-icon
                slot="start"
                name="briefcase-outline"
                class="field-icon"
              ></ion-icon>
              <ion-select
                interface="action-sheet"
                placeholder="Relationship"
                [(ngModel)]="newContact.relationship"
              >
                <ion-select-option
                  *ngFor="let rel of relationships"
                  [value]="rel"
                >
                  {{ rel | titlecase }}
                </ion-select-option>
              </ion-select>
              <ion-icon
                slot="end"
                name="star-outline"
                class="rating-icon"
              ></ion-icon>
            </ion-item>

            <ion-item class="field-card" lines="none">
              <ion-icon
                slot="start"
                name="call-outline"
                class="field-icon"
              ></ion-icon>
              <ion-input
                placeholder="Contact Details"
                [(ngModel)]="newContact.contact_detail"
              ></ion-input>
            </ion-item>

            <ion-item
              class="field-card date-field"
              lines="none"
              (click)="toggleCalendar()"
            >
              <ion-icon
                slot="start"
                name="calendar-outline"
                class="field-icon"
              ></ion-icon>
              <ion-label class="date-label">
                {{ newContact.birthday ? (newContact.birthday | date:'MMM d, y')
                : 'Birthday' }}
              </ion-label>
            </ion-item>

            <!-- Inline calendar -->
            <div *ngIf="calendarOpen" class="inline-calendar">
              <div class="cal-header">
                <button class="cal-nav" (click)="prevYear()">«</button>
                <button class="cal-nav" (click)="prevMonth()">‹</button>
                <div class="cal-title">
                  {{ monthNames[calMonth] }} {{ calYear }}
                </div>
                <button class="cal-nav" (click)="nextMonth()">›</button>
                <button class="cal-nav" (click)="nextYear()">»</button>
              </div>

              <div class="cal-weekdays">
                <div *ngFor="let d of weekdayNames">{{ d }}</div>
              </div>

              <div class="cal-grid">
                <div
                  *ngFor="let cell of calendarCells"
                  class="cal-cell"
                  [class.empty]="!cell"
                  [class.selected]="cell && isSelectedDay(cell)"
                  (click)="cell && selectDay(cell)"
                >
                  <span *ngIf="cell">{{ cell }}</span>
                </div>
              </div>

              <div class="cal-actions">
                <ion-button
                  fill="clear"
                  size="small"
                  (click)="toggleCalendar(false)"
                  >Close</ion-button
                >
              </div>
            </div>
          </ion-list>
        </ion-content>

        <div class="save-footer">
          <ion-button
            expand="block"
            class="add-interaction-btn"
            (click)="openAddInteractionForCurrent()"
          >
            <p style="margin: 0px">Add Interaction</p>
          </ion-button>

          <ion-button expand="block" class="save-btn" (click)="onSubmit()">
            <ion-icon name="save"></ion-icon>
          </ion-button>
        </div>
      </div>
    </ng-template>
  </ion-modal>

  <!-- Add interaction -->
  <ion-modal [isOpen]="showInteractionModal()" cssClass="interaction-modal">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-buttons slot="start">
            <ion-button (click)="closeInteraction()">
              <ion-icon name="arrow-back"></ion-icon>
            </ion-button>
          </ion-buttons>
          <ion-title class="edit-title">Interaction Add</ion-title>
        </ion-toolbar>
      </ion-header>

      <ion-content class="page">
        <section class="form-wrap">
          <!-- Topic -->
          <ion-item lines="none" class="field-card">
            <ion-icon
              name="chatbubbles-outline"
              slot="start"
              class="field-icon"
            ></ion-icon>
            <ion-input
              placeholder="What’s the topic?"
              [(ngModel)]="interaction.topic"
              inputmode="text"
            >
            </ion-input>
          </ion-item>

          <!-- Date -->
          <ion-item
            class="field-card date-field"
            lines="none"
            (click)="toggleInteractionCalendar()"
          >
            <ion-icon
              slot="start"
              name="calendar-outline"
              class="field-icon"
            ></ion-icon>
            <ion-label class="date-label">
              {{ interaction.date ? (interaction.date | date:'MMM d, y') :
              'Date' }}
            </ion-label>
          </ion-item>

          <!-- Inline calendar -->
          <div *ngIf="interactionCalendarOpen" class="inline-calendar">
            <div class="cal-header">
              <button class="cal-nav" (click)="prevInteractionYear()">«</button>
              <button class="cal-nav" (click)="prevInteractionMonth()">
                ‹
              </button>
              <div class="cal-title">
                {{ monthNames[interactionCalMonth] }} {{ interactionCalYear }}
              </div>
              <button class="cal-nav" (click)="nextInteractionMonth()">
                ›
              </button>
              <button class="cal-nav" (click)="nextInteractionYear()">»</button>
            </div>

            <div class="cal-weekdays">
              <div *ngFor="let d of weekdayNames">{{ d }}</div>
            </div>

            <div class="cal-grid">
              <div
                *ngFor="let cell of interactionCalendarCells"
                class="cal-cell"
                [class.empty]="!cell"
                [class.selected]="cell && isSelectedInteractionDay(cell)"
                (click)="cell && selectInteractionDay(cell)"
              >
                <span *ngIf="cell">{{ cell }}</span>
              </div>
            </div>

            <div class="cal-actions">
              <ion-button
                fill="clear"
                size="small"
                (click)="toggleInteractionCalendar(false)"
                >Close</ion-button
              >
            </div>
          </div>

          <!-- Contact -->
          <ion-item lines="none" class="field-card">
            <ion-icon
              name="person-outline"
              slot="start"
              class="field-icon"
            ></ion-icon>
            <ion-select
              [(ngModel)]="interaction.contact"
              interface="action-sheet"
              placeholder="Contact"
            >
              <ion-select-option *ngFor="let c of contactOptions" [value]="c"
                >{{ c.name }}</ion-select-option
              >
            </ion-select>
          </ion-item>

          <!-- Raw Notes -->
          <ion-item lines="none" class="field-card textarea">
            <ion-icon
              name="create-outline"
              slot="start"
              class="field-icon"
            ></ion-icon>
            <ion-textarea
              auto-grow="true"
              placeholder="Raw Notes"
              [(ngModel)]="interaction.rawNotes"
            >
            </ion-textarea>
          </ion-item>

          <!-- Generate button -->
          <ion-button
            class="primary-btn send-btn"
            expand="block"
            (click)="onGenerateInteraction()"
          >
            <ion-icon name="paper-plane-outline" slot="start"></ion-icon>
            Generate
          </ion-button>
        </section>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- AI Review Screen (like your mockup) -->
  <ion-modal [isOpen]="showAiReview()" cssClass="ai-review-modal">
    <ng-template>
      <ion-header>
        <ion-toolbar class="generated-toolbar">
          <ion-buttons slot="start">
            <ion-button (click)="closeAiReview()">
              <ion-icon name="arrow-back"></ion-icon>
            </ion-button>
          </ion-buttons>
          <ion-title>Generated</ion-title>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ai-review-body">
        <ion-item lines="none">
          <ion-icon name="reorder-three-outline" slot="start"></ion-icon>
          <ion-label>AI Output</ion-label>
        </ion-item>

        <div class="ai-block" *ngIf="lastAiFacts() as ai">
          <!-- summary -->
          <h3>{{ ai['summary'] || 'No summary' }}</h3>

          <!-- facts -->
          <div *ngIf="ai['facts']?.length">
            <h4>Facts</h4>
            <ul>
              <li *ngFor="let f of ai['facts']">{{ f }}</li>
            </ul>
          </div>

          <!-- contact notes -->
          <div *ngIf="ai['contact_notes']?.length">
            <h4>Contact Notes</h4>
            <ul>
              <li *ngFor="let n of ai['contact_notes']">{{ n }}</li>
            </ul>
          </div>

          <!-- categories -->
          <div *ngIf="ai['categories']?.length">
            <h4>Categories</h4>
            <ul>
              <li *ngFor="let c of ai['categories']">
                <strong>{{ c['category'] }}</strong> — {{ c['essence'] }}
                <span *ngIf="c['confidence']"> ({{ c['confidence'] }}/5)</span>
              </li>
            </ul>
          </div>
        </div>

        <!-- Bottom actions -->
        <div class="ai-review-actions">
          <ion-button
            color="danger"
            expand="block"
            (click)="rejectAiAndResend()"
          >
            <ion-icon name="close-outline" slot="start"></ion-icon>
            Resend
          </ion-button>

          <ion-button color="success" expand="block" (click)="acceptAi()">
            <ion-icon name="save-outline" slot="start"></ion-icon>
            Accept
          </ion-button>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
