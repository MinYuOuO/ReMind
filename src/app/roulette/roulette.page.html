<ion-header>
  <ion-toolbar class="page-toolbar">
    <ion-buttons slot="start" *ngIf="view !== 'ask'">
      <ion-button fill="clear" (click)="goBack()" aria-label="Back">
        <ion-icon name="arrow-back"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Roulette</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="page">
  <ng-container [ngSwitch]="view">
    <!-- ASK -->
    <section *ngSwitchCase="'ask'" class="screen ask-screen">
      <div class="question-card glass">
        <div class="q-title">Ask a question</div>

        <!-- INPUT BOX -->
        <ion-item lines="none" class="field-card">
          <ion-icon
            name="chatbubbles-outline"
            slot="start"
            class="field-icon"
          ></ion-icon>
          <ion-textarea
            [(ngModel)]="question"
            autoGrow="true"
            placeholder="e.g. What should we do this afternoon?"
            inputmode="text"
          ></ion-textarea>
        </ion-item>

        <ion-button
          class="primary-btn"
          expand="block"
          (click)="generateWithAI()"
          [disabled]="isGenerating"
        >
          <ion-spinner
            *ngIf="isGenerating"
            name="crescent"
            style="margin-right: 8px"
          ></ion-spinner>
          {{ isGenerating ? 'Thinking…' : 'Generate with AI' }}
        </ion-button>

        <!-- Preview the 8 labels if we already have them -->
        <div class="preview" *ngIf="options?.length">
          <div class="preview-title">Preview (8)</div>
          <div class="chips">
            <ion-chip *ngFor="let opt of options">{{ opt }}</ion-chip>
          </div>
          <ion-button class="primary-btn" expand="block" (click)="view='roll'"
            >Open Roulette</ion-button
          >
        </div>
      </div>
    </section>

    <!-- ROLL -->
    <section *ngSwitchCase="'roll'" class="screen roll-screen">
      <div class="wheel-wrap">
        <div
          class="wheel"
          [style.transform]="'rotate(' + spinDegrees + 'deg)'"
          [style.transition]="transitionStyle"
          (transitionend)="onSpinEnd($event)"
        >
          <ul class="labels">
            <li *ngFor="let opt of options; let i = index">
              <div class="anchor" [style.--i]="i">
                <span class="text" [innerHTML]="toTwoLine(opt)"></span>
              </div>
            </li>
          </ul>

          <!-- Hub button -->
          <button
            class="spin-btn"
            (click)="startRoll()"
            [disabled]="isSpinning"
          >
            <span *ngIf="!isSpinning">SPIN</span>
            <span *ngIf="isSpinning">…</span>
          </button>

          <div class="rim"></div>
          <div class="shine"></div>
        </div>

        <div class="pointer" aria-hidden="true"></div>
      </div>

      <div class="banner">
        {{ isSpinning ? 'Rolling…' : (resultText || 'Tap SPIN to start') }}
      </div>

      <ion-button
        class="secondary-btn"
        expand="block"
        fill="clear"
        (click)="startRoll()"
      >
        Spin Again
      </ion-button>
    </section>
  </ng-container>
</ion-content>
