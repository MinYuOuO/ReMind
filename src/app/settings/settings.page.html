<ion-header>
  <ion-toolbar class="page-toolbar">
    <ion-buttons slot="start" *ngIf="view !== 'main'">
      <ion-button fill="clear" (click)="goBack()">
        <ion-icon name="arrow-back"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>
      {{ view === 'main' ? 'Settings' : view === 'privacy' ? 'Privacy Setting' :
      view === 'ai' ? 'AI Features' : view === 'data' ? 'Data Management' : view
      === 'about' ? 'About' : view === 'faq' ? 'FAQs' : view === 'card' ? 'Card'
      : 'Notification' }}
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="page">
  <ng-container [ngSwitch]="view">
    <!-- ========== MAIN PAGE ========== -->
    <section *ngSwitchCase="'main'" class="main-settings">
      <ion-list lines="none" class="menu-list">
        <ion-item button (click)="open('card')" class="menu-card">
          <ion-icon name="person-outline" slot="start"></ion-icon>
          <ion-label>Personal Card</ion-label>
        </ion-item>

        <ion-item button (click)="open('notification')" class="menu-card">
          <ion-icon name="notifications-outline" slot="start"></ion-icon>
          <ion-label>Notification</ion-label>
        </ion-item>

        <ion-item button (click)="open('privacy')" class="menu-card">
          <ion-icon name="lock-closed-outline" slot="start"></ion-icon>
          <ion-label>Privacy Setting</ion-label>
        </ion-item>

        <ion-item button (click)="open('ai')" class="menu-card">
          <ion-icon name="sparkles-outline" slot="start"></ion-icon>
          <ion-label>AI Feature Settings</ion-label>
        </ion-item>

        <ion-item button class="menu-card">
          <ion-icon name="notifications-outline" slot="start"></ion-icon>
          <ion-label>Monotization</ion-label>
        </ion-item>

        <ion-item button (click)="open('data')" class="menu-card">
          <ion-icon name="settings-outline" slot="start"></ion-icon>
          <ion-label>Data Management</ion-label>
        </ion-item>

        <ion-item button (click)="open('about')" class="menu-card">
          <ion-icon name="information-circle-outline" slot="start"></ion-icon>
          <ion-label>About</ion-label>
        </ion-item>

        <ion-item button (click)="open('faq')" class="menu-card">
          <ion-icon name="help-circle-outline" slot="start"></ion-icon>
          <ion-label>FAQs</ion-label>
        </ion-item>
      </ion-list>
    </section>

    <!-- ========== PRIVACY ========== -->
    <section *ngSwitchCase="'privacy'" class="subpage">
      <ion-list lines="none" class="menu-list">
        <ion-item class="menu-card">
          <ion-label>Change / Set Password</ion-label>
        </ion-item>

        <ion-item *ngIf="hasPassword" class="menu-card">
          <ion-label position="stacked">Old Password</ion-label>
          <div style="display: flex; align-items: center; width: 100%">
            <ion-input [type]="showOldPassword ? 'text' : 'password'" [(ngModel)]="oldPassword" placeholder="Enter old password"></ion-input>
            <ion-icon 
              [name]="showOldPassword ? 'eye-off-outline' : 'eye-outline'"
              (click)="showOldPassword = !showOldPassword"
              style="font-size: 1.5em; margin-left: 8px; cursor: pointer;"
            ></ion-icon>
          </div>
        </ion-item>

        <ion-item class="menu-card">
          <ion-label position="stacked">New Password</ion-label>
          <div style="display: flex; align-items: center; width: 100%">
            <ion-input [type]="showNewPassword ? 'text' : 'password'" [(ngModel)]="newPassword" placeholder="Enter new password"></ion-input>
            <ion-icon 
              [name]="showNewPassword ? 'eye-off-outline' : 'eye-outline'"
              (click)="showNewPassword = !showNewPassword"
              style="font-size: 1.5em; margin-left: 8px; cursor: pointer;"
            ></ion-icon>
          </div>
        </ion-item>

        <ion-item class="menu-card">
          <ion-label position="stacked">Confirm New Password</ion-label>
          <div style="display: flex; align-items: center; width: 100%">
            <ion-input [type]="showConfirmPassword ? 'text' : 'password'" [(ngModel)]="confirmPassword" placeholder="Confirm new password"></ion-input>
            <ion-icon 
              [name]="showConfirmPassword ? 'eye-off-outline' : 'eye-outline'"
              (click)="showConfirmPassword = !showConfirmPassword"
              style="font-size: 1.5em; margin-left: 8px; cursor: pointer;"
            ></ion-icon>
          </div>
        </ion-item>

        <ion-item lines="none" class="menu-card">
          <ion-button expand="block" (click)="changePassword()">{{ hasPassword ? 'Change Password' : 'Set Password' }}</ion-button>
        </ion-item>

        <ion-item class="menu-card">
          <ion-label>Biometric Login</ion-label>
          <ion-button fill="clear" (click)="toggleBiometric()">{{ biometricEnabled ? 'Disable' : 'Enable' }}</ion-button>
        </ion-item>
      </ion-list>
    </section>

    <!-- ========== AI FEATURES ========== -->
    <section *ngSwitchCase="'ai'" class="subpage">
      <ion-list lines="none" class="menu-list">
        <ion-item class="menu-card">
          <ion-label>AI Provider</ion-label>
          <ion-select [(ngModel)]="aiProvider" interface="action-sheet">
            <ion-select-option value="none">Disabled</ion-select-option>
            <ion-select-option value="openai">OpenAI</ion-select-option>
            <ion-select-option value="deepseek">DeepSeek</ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item class="menu-card">
          <ion-label position="stacked">API Key</ion-label>
          <ion-input
            type="password"
            [(ngModel)]="aiApiKey"
            placeholder="sk-..."
          ></ion-input>
        </ion-item>

        <ion-item class="menu-card">
          <ion-label position="stacked">Model</ion-label>
          <ion-input
            [(ngModel)]="aiModel"
            placeholder="gpt-4o-mini"
          ></ion-input>
        </ion-item>

        <ion-item lines="none" class="menu-card">
          <ion-button expand="block" (click)="saveAi()" [disabled]="saving">
            {{ saving ? 'Saving...' : 'Save AI Settings' }}
          </ion-button>
        </ion-item>
      </ion-list>
    </section>

    <!-- ========== DATA MANAGEMENT ========== -->
    <section *ngSwitchCase="'data'" class="subpage">
      <ion-list lines="none" class="menu-list">
        <ion-item>
          <ion-label>Export Database</ion-label>
        </ion-item>
        <ion-item button (click)="exportDatabase('sqlite')" class="menu-card">
          <ion-icon name="download-outline" slot="start"></ion-icon>
          <ion-label>Export as SQLite DB</ion-label>
        </ion-item>
        <ion-item button (click)="exportDatabase('excel')" class="menu-card">
          <ion-icon name="document-outline" slot="start"></ion-icon>
          <ion-label>Export as Excel</ion-label>
        </ion-item>

        <!-- ADDED: Import controls -->
        <ion-item>
          <ion-label>Import Database</ion-label>
        </ion-item>

        <ion-item class="menu-card">
          <ion-icon name="download-outline" slot="start"></ion-icon>
          <ion-label>Import SQLite Backup (JSON)</ion-label>
          <ion-button slot="end" (click)="fileInputSqlite.click()">Choose File</ion-button>
        </ion-item>

        <ion-item class="menu-card">
          <ion-icon name="document-outline" slot="start"></ion-icon>
          <ion-label>Import Excel (.xlsx/.xls)</ion-label>
          <ion-button slot="end" (click)="fileInputExcel.click()">Choose File</ion-button>
        </ion-item>

        <!-- Hidden file inputs -->
        <input #fileInputExcel type="file" accept=".xlsx,.xls" style="display:none" (change)="onExcelSelected($event)">
        <input #fileInputSqlite type="file" accept=".json,.db,.sqlite,.sqlite3" style="display:none" (change)="onSqliteSelected($event)">

        <ion-item class="menu-card"
          ><ion-label>Clearing Cache</ion-label></ion-item
        >
      </ion-list>
    </section>

    <!-- ========== ABOUT ========== -->
    <section *ngSwitchCase="'about'" class="subpage">
      <ion-list lines="none" class="menu-list">
        <ion-item class="menu-card"
          ><ion-label>Application Version</ion-label></ion-item
        >
        <ion-item class="menu-card"
          ><ion-label>Issue Feedback</ion-label></ion-item
        >
        <ion-item class="menu-card"
          ><ion-label>Privacy Policy</ion-label></ion-item
        >
        <ion-item class="menu-card"
          ><ion-label>Terms of Service</ion-label></ion-item
        >
      </ion-list>
    </section>

    <!-- ========== FAQ ========== -->
    <section *ngSwitchCase="'faq'" class="subpage">
      <ion-list lines="none" class="menu-list">
        <ion-item class="menu-card"><ion-label>Question 1</ion-label></ion-item>
        <ion-item class="menu-card"><ion-label>Question 2</ion-label></ion-item>
        <ion-item class="menu-card"><ion-label>Question 3</ion-label></ion-item>
        <ion-item class="menu-card"><ion-label>Question 4</ion-label></ion-item>
      </ion-list>
    </section>

    <!-- ========== PERSONAL CARD ========== -->
    <section *ngSwitchCase="'card'" class="personal-card">
      <div class="avatar-wrap">
        <div class="avatar-circle">
          <ion-icon name="person-outline"></ion-icon>
        </div>
      </div>

      <div class="card-block">
        <ion-item lines="none" class="input-row">
          <ion-icon name="person-outline" slot="start"></ion-icon>
          <ion-input class="field-name" placeholder="Full name" [(ngModel)]="personalUsername"></ion-input>
        </ion-item>

        <ion-item lines="none" class="input-row">
          <ion-icon name="call-outline" slot="start"></ion-icon>
          <ion-input class="field-detail" placeholder="Contact details" [(ngModel)]="personalContactDetails"></ion-input>
        </ion-item>

        <ion-item lines="none" class="input-row" button (click)="toggleCalendar(true)">
          <ion-icon name="calendar-outline" slot="start"></ion-icon>
          <ion-input [value]="personalBirthday" placeholder="Birthday (YYYY-MM-DD)" readonly></ion-input>
        </ion-item>
        <div *ngIf="calendarOpen" class="calendar-wrap">
          <div class="calendar-header">
            <button (click)="prevYear()" type="button">&lt;&lt;</button>
            <button (click)="prevMonth()" type="button">&lt;</button>
            <div class="calendar-title">{{ monthNames[calMonth] }} {{ calYear }}</div>
            <button (click)="nextMonth()" type="button">&gt;</button>
            <button (click)="nextYear()" type="button">&gt;&gt;</button>
          </div>
          <div class="calendar-grid">
            <div class="calendar-weekday" *ngFor="let w of weekdayNames">{{ w }}</div>
            <div class="calendar-cell"
                 *ngFor="let day of calendarCells; let i = index"
                 [class.empty]="day === null"
                 [class.selected]="day !== null && isSelectedDay(day!)"
                 (click)="day !== null && selectDay(day!)">
              {{ day !== null ? day : '' }}
            </div>
          </div>
        </div>
      </div>

      <div class="notes-block">
        <label class="notes-label">Notes</label>
        <div class="notes-area">
          <ion-textarea rows="5" placeholder="Notes about yourself" [(ngModel)]="personalNotes"></ion-textarea>
        </div>
      </div>

      <div style="padding:16px;">
        <ion-button expand="block" (click)="savePersonalCard()">Save Personal Card</ion-button>
      </div>
    </section>

    <!-- ========== NOTIFICATION ========== -->
    <section *ngSwitchCase="'notification'" class="noti-page">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px;">
        <div class="noti-section-title">Notifications</div>
        <div>
          <ion-button fill="clear" (click)="clearAllReminders()">Clear All</ion-button>
        </div>
      </div>

      <div *ngIf="reminders?.length === 0" style="color:#6b7aa6; padding: 12px;">No notifications</div>

      <ng-container *ngFor="let r of reminders">
        <div class="noti-card" style="position:relative;">
          <div class="noti-left">
            <ion-icon name="mail-outline"></ion-icon>
          </div>
          <div class="noti-body" (click)="onNotificationClick(r)">
            <div class="noti-title">{{ r.title }}<span *ngIf="r.contact_name"> â€” {{ r.contact_name }}</span></div>
            <div class="noti-sub">{{ r.description || r.due_date_display }}</div>
          </div>
          <ion-button class="trash-btn" fill="solid" size="small" style="position:absolute; right:8px; top:8px;" (click)="$event.stopPropagation(); deleteReminder(r.reminder_id)">
            <ion-icon name="trash-outline"></ion-icon>
          </ion-button>
        </div>
      </ng-container>
    </section>
  </ng-container>
</ion-content>
