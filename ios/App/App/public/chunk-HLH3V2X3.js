import{a as f}from"./chunk-WCLNVVUR.js";import{b as m,c as R}from"./chunk-OJQROCLB.js";import{Aa as I,d as l,e as d}from"./chunk-NFYGWNBG.js";import{f as i}from"./chunk-MCHWYEYM.js";var v=()=>new Date().toISOString(),D=()=>crypto?.randomUUID?crypto.randomUUID():Math.random().toString(36).slice(2),C=(()=>{let s=class s{constructor(t){this.db=t}listByUser(t){return this.db.query("SELECT * FROM contact WHERE user_id = ? ORDER BY name COLLATE NOCASE ASC",[t])}createMinimal(t,e,n="friend",r="",u="",h=""){return i(this,null,function*(){let g=D(),y=v(),c={contact_id:g,user_id:t,name:e,relationship:n,contact_detail:r||null,birthday:u||null,created_at:y,updated_at:y,notes:h||null};return yield this.db.run(`INSERT INTO contact (
        contact_id,
        user_id,
        name,
        relationship, 
        contact_detail,
        birthday,
        created_at,
        updated_at,
        notes
      ) VALUES (?,?,?,?,?,?,?,?,?)`,[c.contact_id,c.user_id,c.name,c.relationship,c.contact_detail,c.birthday,c.created_at,c.updated_at,c.notes]),c})}update(t,e){return i(this,null,function*(){if(!t)return;let n=[],r=[];if(e.name!==void 0&&(n.push("name = ?"),r.push(e.name)),e.relationship!==void 0&&(n.push("relationship = ?"),r.push(e.relationship)),e.contact_detail!==void 0&&(n.push("contact_detail = ?"),r.push(e.contact_detail)),e.birthday!==void 0&&(n.push("birthday = ?"),r.push(e.birthday)),e.notes!==void 0&&(n.push("notes = ?"),r.push(e.notes)),n.push("updated_at = ?"),r.push(v()),!n.length)return;let u=`UPDATE contact SET ${n.join(", ")} WHERE contact_id = ?`;r.push(t),yield this.db.run(u,r)})}delete(t){return i(this,null,function*(){t&&(yield this.db.run("DELETE FROM contact WHERE contact_id = ?",[t]))})}};s.\u0275fac=function(e){return new(e||s)(d(m))},s.\u0275prov=l({token:s,factory:s.\u0275fac,providedIn:"root"});let a=s;return a})();var _="remind.user_id",O="u_local",k=()=>crypto?.randomUUID?crypto.randomUUID():"u-"+Math.random().toString(36).slice(2),$=(()=>{let s=class s{constructor(t,e,n){this.db=t,this.dbInit=e,this.platform=n,this._userId=null,this._readyPromise=null}ready(){return i(this,null,function*(){return this._readyPromise?this._readyPromise:(this._readyPromise=i(this,null,function*(){yield this.platform.ready(),yield this.dbInit.init();let e=(yield f.get({key:_})).value;e||(e=O,yield f.set({key:_,value:e})),yield this.ensureUserRow(e),this._userId=e}),this._readyPromise)})}get userId(){return this._userId??O}ensureUserId(){return i(this,null,function*(){return yield this.ready(),this.userId})}switchUser(t){return i(this,null,function*(){t&&(yield this.ensureUserRow(t),yield f.set({key:_,value:t}),this._userId=t)})}ensureUserRow(t){return i(this,null,function*(){if(yield this.db.open(),!(yield this.db.query("SELECT user_id FROM user WHERE user_id = ?",[t])).length){yield this.db.run(`INSERT INTO user (user_id, username)
         VALUES (?, ?)`,[t,"Local User"]);try{yield this.db.saveToStoreAndClose()}catch(n){console.warn("[UserIdentityService] saveToStore failed after create",n)}}})}createNewLocalUser(t="Local User"){return i(this,null,function*(){let e=k();return yield this.db.open(),yield this.db.run(`INSERT INTO user (user_id, username)
       VALUES (?, ?)`,[e,t]),yield f.set({key:_,value:e}),this._userId=e,e})}};s.\u0275fac=function(e){return new(e||s)(d(m),d(R),d(I))},s.\u0275prov=l({token:s,factory:s.\u0275fac,providedIn:"root"});let a=s;return a})();var T=()=>new Date().toISOString(),x=()=>crypto?.randomUUID?crypto.randomUUID():"i-"+Math.random().toString(36).slice(2),U=(()=>{let s=class s{constructor(t){this.db=t}create(t,e,n,r,u=0,h=null){return i(this,null,function*(){let g=x(),y=T(),c={insight_id:g,contact_id:t,user_id:e,insight_type:n,content:r,generated_at:y,relevant_until:h,is_actionable:u};return yield this.db.run(`INSERT INTO insight (
         insight_id, contact_id, user_id,
         insight_type, content, generated_at,
         relevant_until, is_actionable
       ) VALUES (?,?,?,?,?,?,?,?)`,[c.insight_id,c.contact_id,c.user_id,c.insight_type,c.content,c.generated_at,c.relevant_until,c.is_actionable]),c})}listByContact(t){return this.db.query(`SELECT * FROM insight
       WHERE contact_id = ?
       ORDER BY datetime(generated_at) DESC`,[t])}listByUser(t){return this.db.query(`SELECT * FROM insight
       WHERE user_id = ?
       ORDER BY datetime(generated_at) DESC`,[t])}getById(t){return i(this,null,function*(){return(yield this.db.query("SELECT * FROM insight WHERE insight_id = ?",[t]))[0]??null})}update(t,e){return i(this,null,function*(){let n=[],r=[];if(e.insight_type!==void 0&&(n.push("insight_type = ?"),r.push(e.insight_type)),e.content!==void 0&&(n.push("content = ?"),r.push(e.content)),e.relevant_until!==void 0&&(n.push("relevant_until = ?"),r.push(e.relevant_until)),e.is_actionable!==void 0&&(n.push("is_actionable = ?"),r.push(e.is_actionable)),!n.length)return;let u=`UPDATE insight SET ${n.join(", ")} WHERE insight_id = ?`;r.push(t),yield this.db.run(u,r)})}delete(t){return i(this,null,function*(){yield this.db.run("DELETE FROM insight WHERE insight_id = ?",[t])})}deleteExpired(){return i(this,null,function*(){let t=T();yield this.db.run(`DELETE FROM insight
       WHERE relevant_until IS NOT NULL
         AND datetime(relevant_until) < datetime(?)`,[t])})}listActionable(t){return this.db.query(`SELECT * FROM insight
       WHERE user_id = ? AND is_actionable = 1
       ORDER BY datetime(generated_at) DESC`,[t])}countByContact(t){return i(this,null,function*(){return(yield this.db.query("SELECT COUNT(*) as count FROM insight WHERE contact_id = ?",[t]))?.[0]?.count??0})}};s.\u0275fac=function(e){return new(e||s)(d(m))},s.\u0275prov=l({token:s,factory:s.\u0275fac,providedIn:"root"});let a=s;return a})();function p(a){if(!a)return null;try{return JSON.parse(a)}catch{}let s=a.indexOf("{"),o=a.lastIndexOf("}");if(s>=0&&o>s)try{return JSON.parse(a.slice(s,o+1))}catch{}return null}var b=class{constructor(s,o="gpt-4o-mini",t="https://api.openai.com/v1/chat/completions"){this.apiKey=s,this.model=o,this.baseUrl=t,this.name="openai"}chat(s,o=.2){return i(this,null,function*(){let e=yield(yield fetch(this.baseUrl,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:this.model,messages:s,temperature:o})})).json().catch(()=>({}));return e?.choices?.[0]?.message?.content??e?.choices?.[0]?.text??""})}generateJsonForFacts(s){return i(this,null,function*(){let o={role:"system",content:"You extract structured JSON facts about social interactions. Be concise."},t={role:"user",content:`Return STRICT JSON only, no markdown. Shape:
{
  "summary": "<1 sentence>",
  "facts": ["..."],
  "contact_notes": ["personality/hobby/preference"],
  "categories": [{"category":"values|work_style|communication|behavior","essence":"...", "confidence":3}]
}

`+s},e=yield this.chat([o,t],.2),n=p(e)||{};return{summary:String(n.summary??"").trim(),facts:Array.isArray(n.facts)?n.facts.map(String):[],contact_notes:Array.isArray(n.contact_notes)?n.contact_notes.map(String):[],categories:Array.isArray(n.categories)?n.categories:[]}})}generateInsightText(s){return i(this,null,function*(){let o={role:"system",content:"You are an empathetic assistant. Respond concisely in JSON when asked; otherwise short text."},t={role:"user",content:`Return JSON with keys "summary" and "suggestion" (plain text, <140 chars each). No markdown.

${s}`},e=yield this.chat([o,t],.2),n=p(e);return{summary:n?.summary?String(n.summary).trim():void 0,suggestion:n?.suggestion?String(n.suggestion).trim():n?.reminder?String(n.reminder).trim():void 0,_rawText:e,_rawJson:n}})}generateSuggestions(s){return i(this,null,function*(){let o={role:"system",content:"Return a JSON array of short suggestions only."},t={role:"user",content:`Generate ${s} friendly suggestions (<=12 words) to strengthen friendships. Return JSON array.`},e=yield this.chat([o,t],.7),n=p(e);return Array.isArray(n)?n.map(String).slice(0,s):Array.isArray(n?.suggestions)?n.suggestions.map(String).slice(0,s):e.split(`
`).map(r=>r.replace(/^[\s*-•\d.]+/,"").trim()).filter(Boolean).slice(0,s)})}},E=class{constructor(s,o="deepseek-chat",t="https://api.deepseek.com/chat/completions"){this.apiKey=s,this.model=o,this.baseUrl=t,this.name="deepseek"}chat(s,o=.2){return i(this,null,function*(){let e=yield(yield fetch(this.baseUrl,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:this.model,messages:s,temperature:o})})).json().catch(()=>({}));return e?.choices?.[0]?.message?.content??e?.choices?.[0]?.text??""})}generateJsonForFacts(s){return i(this,null,function*(){let o={role:"system",content:"You extract structured JSON facts about social interactions. Be concise."},t={role:"user",content:`Return STRICT JSON only, no markdown. Shape:
{
  "summary": "<1 sentence>",
  "facts": ["..."],
  "contact_notes": ["personality/hobby/preference"],
  "categories": [{"category":"values|work_style|communication|behavior","essence":"...", "confidence":3}]
}

`+s},e=yield this.chat([o,t],.2),n=p(e)||{};return{summary:String(n.summary??"").trim(),facts:Array.isArray(n.facts)?n.facts.map(String):[],contact_notes:Array.isArray(n.contact_notes)?n.contact_notes.map(String):[],categories:Array.isArray(n.categories)?n.categories:[]}})}generateInsightText(s){return i(this,null,function*(){let o={role:"system",content:"You are an empathetic assistant. Respond concisely in JSON when asked; otherwise short text."},t={role:"user",content:`Return JSON with keys "summary" and "suggestion" (plain text, <140 chars each). No markdown.

${s}`},e=yield this.chat([o,t],.2),n=p(e);return{summary:n?.summary?String(n.summary).trim():void 0,suggestion:n?.suggestion?String(n.suggestion).trim():n?.reminder?String(n.reminder).trim():void 0,_rawText:e,_rawJson:n}})}generateSuggestions(s){return i(this,null,function*(){let o={role:"system",content:"Return a JSON array of short suggestions only."},t={role:"user",content:`Generate ${s} friendly suggestions (<=12 words) to strengthen friendships. Return JSON array.`},e=yield this.chat([o,t],.7),n=p(e);return Array.isArray(n)?n.map(String).slice(0,s):Array.isArray(n?.suggestions)?n.suggestions.map(String).slice(0,s):e.split(`
`).map(r=>r.replace(/^[\s*-•\d.]+/,"").trim()).filter(Boolean).slice(0,s)})}},H=(()=>{let s=class s{constructor(t,e){this.db=t,this.insightRepo=e,this.provider=null}useProvider(t){this.provider=t}useOpenAI(t,e="gpt-4o-mini"){this.provider=new b(t,e)}useDeepSeek(t,e="deepseek-chat"){this.provider=new E(t,e)}summarizeInteractionToFacts(t){return i(this,null,function*(){let e=this.buildFactsPrompt(t);if(!this.provider)return yield this.logProcessing(t,"pending",e,null,0,"No provider configured"),null;try{let n=yield this.provider.generateJsonForFacts(e),r={summary:(n.summary??"").trim(),facts:Array.isArray(n.facts)?n.facts.map(u=>String(u).trim()).filter(Boolean):[],contact_notes:Array.isArray(n.contact_notes)?n.contact_notes.map(u=>String(u).trim()).filter(Boolean):[],categories:Array.isArray(n.categories)?n.categories:[]};if(yield this.logProcessing(t,"success",e,JSON.stringify(r),0,null,null),r.categories?.length)for(let u of r.categories){let h=(u.essence||"").trim();h&&(yield this.db.run(`INSERT INTO cognitive_unit(
             unit_id, contact_id, category, essence,
             confidence_score, last_confirmed, status, created_at, updated_at
           ) VALUES(?,?,?,?,?,?,?,datetime('now'),datetime('now'))`,[crypto?.randomUUID?crypto.randomUUID():"cu-"+Date.now()+"-"+Math.random().toString(36).slice(2),t.contact_id,u.category,h,Math.min(Math.max(Number(u.confidence??3),1),5),null,"active"]))}return r}catch(n){return yield this.logProcessing(t,"error",e,null,0,String(n?.message??n)),null}})}buildFactsPrompt(t){return["Task: Extract structured facts about this single interaction.","Return STRICT JSON ONLY (no markdown) with keys:",'- "summary": "<1 short sentence>"','- "facts": ["..."]','- "contact_notes": ["personality/hobby/preference"]','- "categories": [{"category":"values|work_style|communication|behavior","essence":"...", "confidence":3}]',"Constraints: Keep items short, plain text, <= 140 chars each.","",`Interaction ID: ${t.interaction_id}`,`Contact ID: ${t.contact_id}`,`User ID: ${t.user_id}`,t.context?`Context: ${t.context}`:"",t.user_summary?`User Summary: ${t.user_summary}`:"",t.raw_notes?`Raw Notes: ${t.raw_notes}`:""].filter(Boolean).join(`
`)}generatePersonInsight(t){return i(this,null,function*(){if(!this.provider)return null;let e=this.buildPersonInsightPrompt(t);try{let n=yield this.provider.generateInsightText(e),r=(n.suggestion??n.summary??t.question??"").toString().trim()||"No insight available.";return(yield this.insightRepo.create(t.contact_id,t.user_id,t.type,r,t.actionable??1,t.relevant_until??null)).insight_id}catch(n){return console.warn("[AiInsightService] generatePersonInsight failed:",n),null}})}buildPersonInsightPrompt(t){return[`Task: Produce a concise ${t.type} about this person for the user to read.`,"Constraints: 1\u20132 short sentences, plain text, no markdown, <= 220 chars.",`Contact ID: ${t.contact_id}`,`User ID: ${t.user_id}`,t.question?`Focus: ${t.question}`:"Focus: general relationship maintenance"].join(`
`)}generateRouletteSuggestions(t=8){return i(this,null,function*(){let e=["Text a friend you miss","Share a photo memory today","Plan a short coffee catch-up","Write one thank-you message","Ask a friend about their week","Send a thoughtful voice note","Invite someone for a walk","Celebrate a small win together"];if(!this.provider)return{suggestions:e.slice(0,t)};try{let r=(yield this.provider.generateSuggestions(t)).map(u=>(u||"").trim()).filter(Boolean).slice(0,t);return{suggestions:r.length?r:e.slice(0,t)}}catch{return{suggestions:e.slice(0,t)}}})}logProcessing(t,e,n,r,u=0,h,g){return i(this,null,function*(){let y=crypto?.randomUUID?crypto.randomUUID():"log-"+Date.now(),c=new Date().toISOString(),A=this.provider?.name??null,N=r??(h?JSON.stringify({error:h}):null);yield this.db.run(`INSERT INTO ai_processing_log (
         log_id, interaction_id, processed_at, ai_model,
         input_text, output_json, user_confirmed, status, cognitive_unit_id
       ) VALUES (?,?,?,?,?,?,?,?,?)`,[y,t.interaction_id,c,A,n??null,N??null,u,e,g??null])})}};s.\u0275fac=function(e){return new(e||s)(d(m),d(U))},s.\u0275prov=l({token:s,factory:s.\u0275fac,providedIn:"root"});let a=s;return a})();export{C as a,$ as b,H as c};
